# 产品需求文档 (PRD)

**项目名称：** 本地化视频广告投放识别系统

**版本：** 2.2.1 (性能与稳定性优化)

**日期：** 2025年8月1日 (最新更新)

**作者：** AI助手

---

### 1. 引言

#### 1.1 背景
随着视频广告投放的普及，广告主和监测方对广告投放的实际效果和合规性提出了更高的要求。传统的广告监测方式效率低下，难以实现大规模、实时的监控。本系统旨在利用多模态大模型 Gemma 3 的先进能力，结合**画面内容理解、OCR文字识别和语义相似度比对**，提供一个本地化的视频广告投放识别解决方案，自动检测实际拍摄视频中是否存在特定的广告内容，特别是在复杂的播放设备（如大屏幕、电视）上。

#### 1.2 目标
*   实现高效、准确的视频广告内容**语义识别**。
*   支持从素材视频中提取广告**语义描述**，并与实拍视频中的播放内容进行比对。
*   能够识别出广告内容在实拍视频中出现的具体时间片段。
*   提供包含深度分析和并排视觉证据的PDF报告。
*   提供本地化部署方案，保障数据隐私和处理效率。
*   支持 Mac 平台（包括 Apple Silicon 芯片）部署。

### 2. 功能需求

#### 2.1 核心功能

##### 2.1.1 素材视频管理
*   **素材上传：** 用户能够通过命令行或UI上传MP4、AVI、MOV等常见格式的素材视频文件。
*   **素材预处理：**
    *   **关键帧提取：** 系统自动从素材视频中提取代表性关键帧（如第一帧、中间帧、倒数第25帧）。
    *   **语义描述生成：** 利用 **LM Studio** 提供的 **Gemma 3 多模态大模型** 对素材视频的关键帧进行**语义描述生成**，同时结合 **EasyOCR** 技术识别画面中的文字，将画面内容和文字信息整合为富有语义的文本描述，作为该素材的“语义指纹”。
    *   **方向识别与存储：** 系统自动识别素材视频的横向或纵向方向，并将其与语义描述一同存储在数据库中。
    *   **描述持久化：** 将素材的“语义指纹”（文本描述）及其文件名**持久化存储**在本地SQLite数据库中，作为比对基准。

##### 2.1.2 实拍视频处理与广告检测
*   **实拍视频上传：** 用户能够通过命令行或UI上传MP4、AVI、MOV等常见格式的实拍视频文件。
*   **逐帧分析：** 系统逐帧（或按固定时间间隔，如1秒）解析实拍视频流。
*   **视频播放区域检测：** 对于视频流中的每一帧，系统首先利用计算机视觉技术**识别并聚焦到视频播放设备在屏幕中的区域**（Region of Interest），排除背景干扰。
*   **实时语义描述生成：** 对检测到的视频播放区域进行裁剪，并利用 **LM Studio** 提供的 **Gemma 3 多模态大模型** 结合 **EasyOCR** 技术，实时生成该区域的**语义描述**。
*   **语义相似度计算：** 将每一帧的语义描述与缓存中所有素材的语义描述进行**语义相似度计算**。此过程通过 **LM Studio** 提供的 **文本嵌入模型** 将文本描述转换为高维文本嵌入向量，然后计算这些向量的余弦相似度。
*   **匹配片段记录：** 当某一帧的语义相似度超过预设阈值时，系统会记录下该匹配发生的时间点（在实拍视频中的秒数）以及匹配上的具体素材文件名。

##### 2.1.3 结果整合与输出
*   **数据整理：** 检测完成后，系统会整理所有记录下的匹配点，计算出每个广告素材在实拍视频中累计出现的总时长。
*   **关键证据定位：** 系统会找出语义相似度最高的几个匹配瞬间，作为生成报告的核心证据。
*   **数据打包：** 将所有分析结果（最佳匹配素材、最高相似度、累计时长、关键证据的时间戳等）打包成一个结构化数据，传递给报告生成模块。

#### 2.2 辅助功能

##### 2.2.1 结果报告生成
系统必须能生成一份详细、专业、包含可信证据的PDF报告。报告必须包含以下部分：

1.  **报告标题与摘要：**
    *   明确的标题，如“视频广告检测报告”。
    *   **摘要信息块**，清晰列出：
        *   被检测的实拍视频文件名。
        *   匹配上的广告素材文件名。
        *   检测到的最高**语义相似度**分数。
        *   **源素材总时长** (秒)。
        *   **广告在实拍视频中累计出现的总时长** (秒)。

2.  **并排视觉证据对比：**
    *   报告的核心部分，必须以**表格形式**展示对比证据。
    *   表格应为两列，左列为“**实拍视频截图**”，右列为“**源素材截图**”。
    *   表格中应包含至少`N`组（N可配置，默认为3）语义相似度最高的匹配瞬间截图。
    *   **精确时间戳标注：** 每一组对比截图的下方，必须清晰标注该截图在各自视频中的时间点，格式为 `Time: XX.XXs`。
    *   截图应按比例缩放，保持清晰度和布局美观。

##### 2.2.2 性能与稳定性优化
*   **Web界面缓存功能：** Web界面（`run_gui.py`）现在引入了缓存机制，当用户多次对同一个录制视频进行“检查广告”操作时，如果该视频的帧数据已被处理，系统将直接使用缓存数据，避免重复耗时的视频帧提取和处理过程，显著提升二次检测的速度。
*   **核心逻辑稳定性提升：** 修复了 `ad_detector.py` 中由于 `material_time` 类型错误导致的 `ValueError`，并解决了访问 `MATERIAL_DESCRIPTIONS_CACHE` 时 `KeyError` 的问题，提高了匹配逻辑的健壮性。

*   **日志管理：** 记录系统运行日志、错误信息、警告信息等，方便故障排查。
*   **配置管理：** 通过 `config.py` 文件管理模型路径、语义相似度阈值、报告截图数量等参数。

### 3. 非功能需求

(与上一版基本相同，保持不变)

### 4. 技术选型

- **核心框架**: Python
- **AI模型**: `google/gemma-3-4b-it` (多模态理解，通过 **LM Studio API**)
- **文本嵌入**: `nomic-ai/nomic-embed-text-v1.5` (语义相似度计算，通过 **LM Studio API**)
- **光学字符识别 (OCR)**: EasyOCR
- **机器学习**: PyTorch, scikit-learn
- **视频/图像处理**: OpenCV, Pillow
- **报告生成**: ReportLab
- **Web界面**: Streamlit
- **数据库**: SQLite (用于素材文件名管理)

### 5. 部署与环境要求

(与上一版基本相同，保持不变)

### 6. 验收标准

*   成功上传并处理指定数量的素材视频和实拍视频。
*   广告**语义识别**准确率达到预设阈值（如85%）。
*   **生成的PDF报告必须包含所有在“2.2.1 结果报告生成”中定义的元素。**
*   **报告中的对比截图必须清晰，且与下方标注的时间戳准确对应。**
*   **报告中展示的时长数据（源素材时长、匹配总时长）必须计算准确。**
*   系统运行稳定，在处理常规视频文件时无明显崩溃或卡顿。
*   用户能够通过命令行独立完成从素材上传到结果查看的全流程操作。

### 7. 未来展望

*   支持多广告同时识别与追踪。
*   集成音频识别，增强广告识别的鲁棒性。
*   支持更复杂的播放设备（如曲面屏、反光严重屏幕）。
*   Web端UI或API接口的进一步增强。

---
