好的，明白了！Mac 平台开发确实没有 CUDA 支持，这对于依赖 NVIDIA GPU 进行加速的深度学习任务来说是一个重要的限制。

针对 Mac 平台（尤其是搭载 Apple Silicon 芯片的 Mac），主要的替代方案是利用 **MPS (Metal Performance Shaders)**，这是苹果为机器学习提供的加速框架。

我现在为您更新 PRD 文档中的“技术选型”和“部署与环境要求”部分，以适应 Mac 开发环境，并强调使用 MPS 或 CPU 进行推理。

---

**产品需求文档 (PRD)**

**项目名称：** 本地化视频广告投放识别系统

**版本：** 1.2

**日期：** 2025年7月30日

**作者：** AI助手

---

### 1. 引言

#### 1.1 背景
随着视频广告投放的普及，广告主和监测方对广告投放的实际效果和合规性提出了更高的要求。传统的广告监测方式效率低下，难以实现大规模、实时的监控。本系统旨在利用多模态大模型 Gemma 3 的先进能力，提供一个本地化的视频广告投放识别解决方案，自动检测实际拍摄视频中是否存在特定的广告内容，特别是在复杂的播放设备（如大屏幕、电视）上。

#### 1.2 目标
* 实现高效、准确的视频广告内容识别。
* 支持从素材视频中提取广告特征，并与实拍视频中的播放内容进行比对。
* 能够识别实拍视频中的播放设备，并在其播放内容中进行广告检测。
* 提供清晰的证据（视频截图）以支持识别结果。
* 提供本地化部署方案，保障数据隐私和处理效率。
* **支持 Mac 平台（包括 Apple Silicon 芯片）部署。**

### 2. 功能需求

#### 2.1 核心功能

##### 2.1.1 素材视频管理
* **素材上传：** 用户能够上传MP4、AVI、MOV等常见格式的素材视频文件。
* **素材预处理：**
    * **关键帧提取：** 系统自动从素材视频中提取代表性关键帧。
    * **多模态特征编码：** 利用 Gemma 3 对素材视频（包括关键帧、音频、文本等）进行多模态特征编码，生成特征向量，作为后续比对的基准。
    * **元数据存储：** 存储素材视频的文件名、上传时间、特征向量等元数据。

##### 2.1.2 实拍视频处理与监控
* **实拍视频上传：** 用户能够上传MP4、AVI、MOV等常见格式的实拍视频文件。
* **实时/准实时处理（可选，取决于本地算力）：**
    * **视频流解析：** 解析实拍视频流，逐帧或按固定间隔提取视频帧。
    * **播放设备检测：** 利用 Gemma 3 的目标检测能力，在每个视频帧中识别并定位潜在的播放设备（如电视屏幕、LED大屏、手机屏幕、电脑屏幕等）。
        * **挑战：** 屏幕可能存在透视变形、光照变化、部分遮挡、低分辨率等情况，需要 Gemma 3 的鲁棒性处理。
    * **屏幕内容提取与校正：** 对检测到的播放设备区域进行裁剪，并进行图像校正（如透视校正、色彩校正），以标准化屏幕上的内容。
    * **屏幕内容特征编码：** 利用 Gemma 3 对校正后的屏幕内容进行多模态特征编码。

##### 2.1.3 广告内容比对与识别
* **特征相似度计算：** 将实拍视频中提取的屏幕内容特征向量与所有已上传的素材视频特征向量进行相似度计算（例如余弦相似度）。
* **匹配阈值设置：** 用户可以设置相似度阈值。当匹配度超过该阈值时，系统判定为广告匹配成功。
* **匹配结果输出：**
    * **匹配成功信息：** 显示匹配到的素材视频名称、匹配的时间戳（实拍视频中出现广告的时间点）、匹配度分数。
    * **匹配区域高亮：** 可视化显示实拍视频中被识别为广告的屏幕区域。
    * **不匹配信息：** 如果未检测到匹配广告，则给出相应提示。

#### 2.2 辅助功能

* **结果报告生成：** 生成包含识别结果的报告，可导出为CSV、PDF等格式，包括：
    * 检测到广告的视频列表。
    * 每个广告的出现时间、持续时长（可选，需时间序列匹配）。
    * 匹配准确率（如果有多轮测试数据）。
    * **匹配证据截图：针对每次成功识别的广告，系统需自动截取3-5张实拍视频画面作为证据，通常包括广告播放的“开头”、“中间”和“结尾”部分。这些截图应清晰显示广告内容在播放设备上的呈现，并可在报告中附带或链接。**
* **日志管理：** 记录系统运行日志、错误信息、警告信息等，方便故障排查。
* **配置管理：**
    * 设置 Gemma 3 模型路径、配置参数。
    * 调整特征提取粒度、相似度计算算法。
    * 自定义输出路径。

### 3. 非功能需求

#### 3.1 性能
* **处理速度：**
    * 素材视频预处理：取决于视频长度和质量，目标在分钟级完成。
    * 实拍视频分析：目标达到准实时（例如，对于30帧/秒的视频，处理速度不低于10帧/秒），**Mac 平台性能将依赖于 Apple Silicon 芯片的 MPS 加速能力或 CPU 性能。对于大型 Gemma 3 模型，CPU 模式可能较慢。**
* **准确性：** 广告识别准确率目标达到90%以上，屏幕检测准确率目标达到95%以上。
* **资源占用：** 合理管理CPU、GPU（或Apple Silicon）、内存资源，避免系统崩溃。

#### 3.2 可用性
* **用户界面：** 提供直观、易用的图形用户界面（GUI），方便用户进行操作。
* **易用性：** 上传、配置、查看结果等操作流程简单明了。

#### 3.3 可靠性
* **稳定性：** 系统在长时间运行和大量视频处理时保持稳定，不易崩溃。
* **错误处理：** 对文件损坏、网络中断（如果涉及在线Gemma模型加载）、硬件故障等异常情况有适当的错误处理机制。

#### 3.4 安全性
* **数据隐私：** 所有视频处理均在本地进行，不上传到云端，确保数据隐私。
* **模型安全：** Gemma 3 模型文件本地存储，防止未授权访问。

#### 3.5 扩展性
* **模型更新：** 能够方便地更新或替换更高版本的 Gemma 模型。
* **功能模块化：** 系统设计应模块化，便于未来扩展新功能（如多屏幕同时检测、广告时长统计等）。

#### 3.6 兼容性
* **操作系统：** **MacOS (推荐 Ventura 13.0 及以上版本)**。
* **硬件：** 对硬件要求进行明确说明（例如，**推荐搭载 Apple Silicon 芯片的 Mac，以利用 MPS 加速；Intel Mac 性能可能受限**）。

### 5. 技术选型（基于Gemma 3 本地化部署）

* **核心模型：** PaliGemma2-3B-PT-224 (本地部署版本)。
* **编程语言：** Python (生态丰富，便于集成AI库)。
* **深度学习框架：** PyTorch / TensorFlow (Gemma 3 对应的框架)。
    * **加速框架：** **PyTorch 的 `torch.backends.mps` (Metal Performance Shaders) 或 TensorFlow 的 `tensorflow-metal` (针对 Apple Silicon)，如果 Gemma 3 模型支持这些后端加速。如果不支持或性能不佳，则回退到 CPU 推理。**
* **视频处理库：** OpenCV (用于视频帧提取、图像处理、透视校正、截图等)。
* **GUI框架（可选）：** PyQt / Streamlit / Gradio (用于快速开发用户界面)。
* **数据存储：** 本地文件系统 / SQLite (用于存储元数据)。

### 6. 部署与环境要求

* **操作系统：** **MacOS Ventura 13.0 或更高版本。**
* **硬件：**
    * **CPU：** Apple M1 / M2 / M3 系列芯片（或 Intel i7 / i9，但性能可能受限）。
    * **统一内存：** 推荐 16GB RAM 或更高（Apple Silicon 的统一内存对模型推理至关重要）。
    * **存储：** 200GB SSD 空间用于模型和数据存储。
* **软件：**
    * Python 3.9+
    * **Gemma 3 本地模型文件及相关的 PyTorch 或 TensorFlow (需安装支持 MPS 的版本) 等依赖库。**
    * **注意：无需 CUDA Toolkit。**

### 7. 验收标准

* 成功上传并处理指定数量的素材视频和实拍视频。
* 在实拍视频中准确识别出播放设备，并高亮显示。
* 广告识别准确率达到预设阈值。
* 每次成功识别的广告，均能生成并附带3-5张（开头、中间、结尾）清晰的视频截图作为证据。
* 系统运行稳定，无明显崩溃或卡顿。
* 生成的报告内容完整、准确。
* 用户能够独立完成从素材上传到结果查看的全流程操作。

### 8. 未来展望

* 支持多广告同时识别与追踪。
* 集成音频识别，增强广告识别的鲁棒性。
* 支持更复杂的播放设备（如曲面屏、反光严重屏幕）。
* 广告投放时长统计和频次统计功能。
* Web端UI或API接口。

---

**关键变化和考量：**

1.  **硬件/系统明确：** 明确指出了 Mac 平台，并推荐 Apple Silicon 芯片。
2.  **加速替代：** 将 CUDA 替换为 **MPS (Metal Performance Shaders)** 作为 Apple Silicon 上的加速方案。需要确保 Gemma 3 的底层框架（如 PyTorch 或 TensorFlow）有良好的 MPS 支持。
3.  **性能预期调整：** 强调在 Mac 平台，尤其是 Intel Mac 上，处理速度可能不如 NVIDIA GPU 加速的 Windows/Linux 平台，这取决于 Gemma 3 模型是否能有效利用 MPS 加速。对于较大的模型，纯 CPU 推理可能会很慢。
4.  **环境要求更新：** 移除了 CUDA 相关依赖。

请注意，Gemma 3 模型在 MPS 上的性能表现需要实际测试，因为它涉及到模型本身的优化以及 PyTorch/TensorFlow 对 MPS 的支持程度。对于较大的 Gemma 模型，即便有 MPS，处理速度也可能不如高端 NVIDIA GPU。如果性能成为瓶颈，可能需要考虑量化模型或使用更小的 Gemma 变体。