# 产品需求文档 (PRD)

**项目名称：** 本地化视频广告投放识别系统

**版本：** 2.3.0 (引入图像聚类与批量处理)

**日期：** 2025年8月1日 (最新更新)

**作者：** AI助手

---

### 1. 引言

#### 1.1 背景
随着视频广告投放的普及，广告主和监测方对广告投放的实际效果和合规性提出了更高的要求。传统的广告监测方式效率低下，难以实现大规模、实时的监控。本系统旨在利用多模态大模型 Gemma 3N 的先进能力，结合**高效的图像聚类预处理**和**深度语义相似度比对**，提供一个本地化的视频广告投放识别解决方案，自动检测实际拍摄视频中是否存在特定的广告内容。

#### 1.2 目标
*   实现高效、准确的视频广告内容**语义识别**。
*   支持从素材视频中提取广告**语义描述**，并与实拍视频中的播放内容进行比对。
*   通过**图像聚类**大幅提升处理效率，减少对AI模型的冗余调用。
*   能够识别出广告内容在实拍视频中出现的具体时间片段。
*   提供包含深度分析和并排视觉证据的PDF报告。
*   支持**批量处理**多个待检测视频。
*   提供本地化部署方案，保障数据隐私和处理效率。

### 2. 功能需求

#### 2.1 核心功能

##### 2.1.1 素材视频管理
*   **素材上传：** 用户能够通过UI上传MP4、AVI、MOV等常见格式的素材视频文件。
*   **素材预处理：**
    *   **关键帧提取：** 系统自动从素材视频中提取代表性关键帧（如第一帧、中间帧、最后一帧）。
    *   **语义描述生成：** 利用 **LM Studio** 提供的 **Gemma 3N 多模态大模型** 对素材视频的关键帧进行**语义描述生成**，作为该素材的“语义指纹”。
    *   **方向识别与存储：** 系统自动识别素材视频的横向或纵向方向，并将其与语义描述一同存储在数据库中。
    *   **描述持久化：** 将素材的“语义指纹”（文本描述）及其文件名**持久化存储**在本地SQLite数据库中，作为比对基准。

##### 2.1.2 实拍视频处理与广告检测
*   **批量视频上传：** 用户能够通过UI一次性上传多个MP4、AVI、MOV等常见格式的实拍视频文件。
*   **高效预处理流水线：**
    1.  **批量抽帧：** 系统对每个上传的视频，按固定时间间隔（如1秒）提取所有帧。
    2.  **图像聚类：** 使用**感知哈希算法 (`imagehash`)** 对所有提取的帧进行快速相似度计算，将视觉上高度相似的帧（如静止或微小变化的画面）归为一类。
    3.  **代表帧选取：** 从每个聚类中仅选取一个**代表帧**进入下一阶段的分析。
*   **代表帧语义分析：**
    *   对每个**代表帧**，利用 **LM Studio** 提供的 **Gemma 3N 多模态大模型**生成其**语义描述**。
*   **语义相似度计算：** 将每个代表帧的语义描述与数据库中所有素材的语义描述进行**语义相似度计算**（通过文本嵌入向量的余弦相似度）。
*   **匹配片段记录：** 当某一代表帧的语义相似度超过预设阈值时，系统会记录下该匹配发生的时间点以及匹配上的具体素材文件名。

##### 2.1.3 结果整合与输出
*   **数据整理：** 检测完成后，系统会整理所有记录下的匹配点，计算出每个广告素材在实拍视频中累计出现的总时长。
*   **关键证据定位：** 系统会找出语义相似度最高的几个匹配瞬间，作为生成报告的核心证据。
*   **数据打包：** 将所有分析结果（最佳匹配素材、最高相似度、累计时长、关键证据的时间戳等）打包成一个结构化数据，传递给报告生成模块。

#### 2.2 辅助功能

##### 2.2.1 结果报告生成
系统必须能为每个检测出广告的视频生成一份详细、专业、包含可信证据的PDF报告。报告必须包含以下部分：

1.  **报告标题与摘要**
2.  **并排视觉证据对比**

(具体内容要求与上一版相同)

##### 2.2.2 性能与稳定性优化
*   **图像聚类：** 通过感知哈希算法对视频帧进行聚类，避免了对每一个单独的帧都进行昂贵的AI模型调用，显著降低了计算成本和处理时间。
*   **批量处理界面：** GUI支持多文件上传和结果展示，优化了用户体验。
*   **日志管理与配置管理** (保持不变)

### 3. 非功能需求

(与上一版基本相同，保持不变)

### 4. 技术选型

- **核心框架**: Python
- **AI模型**: `google/gemma-3n` (多模态理解，通过 **LM Studio API**)
- **文本嵌入**: `nomic-ai/nomic-embed-text-v1.5` (语义相似度计算，通过 **LM Studio API**)
- **图像聚类**: ImageHash
- **机器学习**: PyTorch, scikit-learn
- **视频/图像处理**: OpenCV, Pillow
- **报告生成**: ReportLab
- **Web界面**: Streamlit
- **数据库**: SQLite

### 5. 部署与环境要求

(与上一版基本相同，保持不变)

### 6. 验收标准

*   成功上传并处理指定数量的素材视频和**批量**实拍视频。
*   广告**语义识别**准确率达到预设阈值（如85%）。
*   **生成的PDF报告必须包含所有在“2.2.1 结果报告生成”中定义的元素。**
*   **报告中的对比截图必须清晰，且与下方标注的时间戳准确对应。**
*   **报告中展示的时长数据（源素材时长、匹配总时长）必须计算准确。**
*   系统运行稳定，在处理常规视频文件时无明显崩溃或卡顿。
*   用户能够通过**图形界面**独立完成从素材上传到批量检测、再到结果查看的全流程操作。

### 7. 未来展望

(与上一版基本相同，保持不变)

---
